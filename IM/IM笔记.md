## **微信的海量IM聊天消息序列号生成实践（算法原理篇）**

### 1、点评


对于IM系统来说，如何做到IM聊天消息离线差异拉取（差异拉取是为了节省流量）、消息多端同步、消息顺序保证等，是典型的IM技术难点。

通过微信团队分享的微信消息序列号生成思路，实际上要解决消息的唯一性、顺序性问题，可以将一个技术点分解成两个：即将原先每条消息一个自增且唯一的消息ID分拆成两个关键属性——消息ID（msgId）、消息序列号（seqId），即消息ID只要保证唯一性而不需要兼顾顺序性（比如直接用UUID）、消息序列号只要保证顺序性而不需要兼顾唯一性（就像本文中微信的思路一样），这样的技术分解就能很好的解决原本一个消息ID既要保证唯一性又要保证顺序性的难题。



### IM群聊消息，怎么保证各接收方收到顺序一致


IM群聊消息的需求，N个群友在一个群里聊，怎么保证所有群友收到的消息显示时序一致？

**答案是：**

- 不能再利用发送方的seq来保证时序，因为发送方不单点，时间也不一致；
- 可以利用服务器的单点做序列化。

![如何保证IM实时消息的“时序性”与“一致性”？_9.jpg](http://www.52im.net/data/attachment/forum/201702/17/120648h15fe7f66f76ep66.jpg)



**此时IM群聊的发送流程为：**



- sender1发出msg1，sender2发出msg2；
- msg1和msg2经过接入集群，服务集群；
- service层到底层拿一个唯一seq，来确定接收方展示时序；
- service拿到msg2的seq是20，msg1的seq是30；
- 通过投递服务讲消息给多个群友，群友即使接收到msg1和msg2的时间不同，但可以统一按照seq来展现。


这个方法能实现，所有群友的消息展示时序相同。缺点是，这个生成全局递增序列号的服务很容易成为系统瓶颈，还有没有进一步的优化方法呢？

**优化思路是：**群消息其实也不用保证全局消息序列有序，而只要保证一个群内的消息有序即可，这样的话，“id串行化”就成了一个很好的思路。
![如何保证IM实时消息的“时序性”与“一致性”？_10.jpg](http://www.52im.net/data/attachment/forum/201702/17/120805je8epnpnnv0e7n7e.jpg)
这个方案中，service层不再需要去一个统一的后端拿全局seq，而是在service连接池层面做细小的改造，保证一个群的消息落在同一个service上，这个service就可以用本地seq来序列化同一个群的所有消息，保证所有群友看到消息的时序是相同的。

关于id串行化的细节，可详见《[利用id串行化解决缓存与数据库一致性问题](http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=404202261&idx=1&sn=1b8254ba5013952923bdc21e0579108e&scene=21#wechat_redirect)》，此处不展开。