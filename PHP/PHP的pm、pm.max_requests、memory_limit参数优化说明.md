
===============================================
## PHP的pm、pm.max_requests、memory_limit参数优化说明
1. php-fpm.conf中的pm
pm是来控制php-fpm的工作进程数到底是一次性产生固定不变（static）还是在运行过程中随着需要动态变化（dynamic）。众所周知，工作进程数与服务器性能息息相关，太少则不能及时处理请求，太多则会占用内存过大而拖慢系统。因为php-fpm处理请求时会随着处理的请求数的增加而占用越来越多的内存，所以static模式下往往不好判断启动的能使内存利用最大化的固定进程数，所以想到了dynamic模式。可是为什么我们不用dynamic模式呢，试想某个时刻请求数比较低，20个进程足够应付，突然压力增大了，出现了40个并发PHP请求，按照最小5个空闲进程的设置就需要45个进程，也就是说需要在短时间内创建出25个进程，我们知道创建进程的操作是比较消耗系统资源的，再加上40个并发PHP请求肯定也会给MySQL带来一定的压力，此时再创建25个进程无疑是雪上加霜，所以我在这里还是选择了static模式。

2. php-fpm.conf中的pm.max_requests
根据说明我们知道这个参数的含义是php-fpm工作进程处理完多少请求后自动重启，主要目的就是为了控制请求处理过程中的内存溢出，使得内存占用在一个可接受的范围内。从这里我们感觉这个数字似乎设置的小一点更加有利于性能提升，但是当这个数字非常小的时候会发生一种情况，由于PHP请求是平均地分配给各个工作进程的，如果这个值太小就会导致所有的工作进程几乎同时达到这个值并且进入需要重启的状态，当所有的工作进程都在同一时刻重启就会发生在数秒内甚至更长的时间PHP将停止响应直到所有的进程均重启完为止。这是不能接受的，所以我一般会把这个值设置为PHP启动后第一批工作进程达到此值需要重启时，第一个进程重启与最后一个进程重启之间的时间相差1分钟以上，一般在压力比较大的晚上这个差值将会扩大到5分钟左右，此时对进程重启对服务器的负面影响就可以忽略了。

3. php.ini中的memory_limit
顾名思义，这个值是用来限制PHP所占用的内存的，具体一点说就是一个PHP工作进程即php-fpm所能够使用的最大内存，默认是128MB，一开始在虚拟机中我设置为PHP 5.1.6的默认值16MB，发现大于16MB的附件将无法下载，也就是说PHP 5.3中附件是从硬盘完整读取到PHP内存中再传给nginx的，这跟PHP 5.1.6+Apache 2.2.3不同，后者读取附件是PHP并不加载这个附件而是直接交给Apache来加载，这就使得php-fpm占用内存大了不少。当php-fpm占用内存达到了memory_limit所限制的值时，当前进程会被fpm主进程使用TERM信号终止掉，此时被处理的PHP请求将返回客户端502错误，nginx的error log中将记录出错原因是“Connection reset by peer”。可是更加令人难以理解的事情发生了，在使用了eAccelerator的PHP 5.3上，居然发生了当php-fpm内存达到memory_limit所限制的值时，所有进程都开始疯狂重启而不再接受任何请求，此时除非使用kill命令杀死主进程，否则php-fpm永远都不会恢复响应，可想而知nginx必然出现无止境的502错误了。。。


## 网站502与504错误分析

一. 戏说
不管你是做运维还是做开发，哪怕你是游客，时不时会遇到502 Bad Gateway或504 Gateway Time-out。出现这页面，把服务重启下，再实在不行重启下服务器，问题就解决了，但是，这问题还是会困扰着你，特别是做运维的人员。夜黑风高正酣睡时，一个电话响起，让你重启服务或IISRESET，肯定是极大不爽，立马要问候他妈了。呵呵，本文总结502与504故障分析与解决方法。

二. 状态码解释
502 Bad Gateway：作为网关或者代理工作的服务器尝试执行请求时，从上游服务器接收到无效的响应。
504 Gateway Time-out：作为网关或者代理工作的服务器尝试执行请求时，未能及时从上游服务器（URI标识出的服务器，例如HTTP、FTP、LDAP）或者辅助服务器（例如DNS）收到响应。

三. 502 Bad Gateway原因分析
将请求提交给网关如php-fpm执行，但是由于某些原因没有执行完毕导致php-fpm进程终止执行。说到此，这个问题就很明了了，与网关服务如php-fpm的配置有关了。
php-fpm.conf配置文件中有两个参数就需要你考虑到，分别是max_children和request_terminate_timeout。
max_children最大子进程数，在高并发请求下，达到php-fpm最大响应数，后续的请求就会出现502错误的。可以通过netstat命令来查看当前连接数。
request_terminate_timeout设置单个请求的超时终止时间。还应该注意到php.ini中的max_execution_time参数。当请求终止时，也会出现502错误的。
当积累了大量的php请求，你重启php-fpm释放资源，但一两分钟不到，502又再次呈现，这是什么原因导致的呢？ 这时还应该考虑到数据库，查看下数据库进程是否有大量的locked进程，数据库死锁导致超时，前端终止了继续请求，但是SQL语句还在等待释放锁，这时就要重启数据库服务了或kill掉死锁SQL进程了。
对于长时间的请求可以考虑使用异步方式，可以参阅《关于PHP实现异步操作的研究》。

四. 504 Gateway Time-out原因分析
504错误一般是与nginx.conf配置有关了。主要与以下几个参数有关：fastcgi_connect_timeout、fastcgi_send_timeout、fastcgi_read_timeout、fastcgi_buffer_size、fastcgi_buffers、fastcgi_busy_buffers_size、fastcgi_temp_file_write_size、fastcgi_intercept_errors。特别是前三个超时时间。如果fastcgi缓冲区太小会导致fastcgi进程被挂起从而演变为504错误。

五. 小结
总而言之，502错误主要从四个方向入手：
1. max_children
2. request_terminate_timeout、max_execution_time
3. 数据库
4. 网关服务是否启动如php-fpm

504错误主要查看nginx.conf关于网关如fastcgi的配置。