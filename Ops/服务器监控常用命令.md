# 服务器监控常用命令

IOPS (Input/Output Operations Per Second)，即每秒进行读写（I/O）操作的次数

1. 查看网络连接
```sh
netstat -an |wc -l                 # 查看网络连接数
netstat -an |grep xx |wc -l        # 查看某个/特定ip的连接数
netstat -an |grep TIME_WAIT|wc -l    # 查看连接数等待time_wait状态连接数
netstat -an |grep ESTABLISHED |wc -l # 查看建立稳定连接数量
```
2. 统计tcp连接数
```sh
netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'
LAST_ACK 1
SYN_RECV 14    # 表示正在等待处理的请求数；
ESTABLISHED 79 # 表示正常数据传输状态；
FIN_WAIT1 28
FIN_WAIT2 3
CLOSING 5
TIME_WAIT 1669 # 表示处理完毕，等待超时结束的请求数;
```
/^tcp/ 滤出tcp开头的记录，屏蔽udp, socket等无关记录。
S[] 相当于定义了一个名叫S的数组, NF 表示记录的字段数，如上所示的记录，NF等于6
$NF 表示某个字段的值，如上所示的记录，$NF也就是$6，表示第6个字段的值，也就是TIME_WAIT
S[$NF] 表示数组元素的值，如上所示的记录，就是S[TIME_WAIT]状态的连接数
++S[$NF] 表示把某个数加一，如上所示的记录，就是把S[TIME_WAIT]状态的连接数加一
END 表示在最后阶段要执行的命令
for(a in S) 遍历数组
print a, S[a] 打印数组的键和值

3. 查看每个ip跟服务器建立的连接数
```sh
netstat -nat|awk '{print$5}'|awk -F : '{print$1}'|sort|uniq -c|sort -rn
```

4. 查看耗时最高的接口
```sh
awk -F ' ' '{print $14,$4,$7}' access.log  | sort -k1nr | head -n 10
```

5. 统计请求次数最多的接口

```sh
grep -v HEAD access.log | awk -F ' ' '{print $7}' | sort | uniq -c | sort -k1nr | head -10
```

linux下获取占用CPU资源最多的10个进程，可以使用如下命令组合：

```sh
ps aux|head -1;ps aux|grep -v PID|sort -rn -k +3|head
```
linux下获取占用内存资源最多的10个进程，可以使用如下命令组合：

```sh
ps aux|head -1;ps aux|grep -v PID|sort -rn -k +4|head
```
看一下是哪个线程CPU消耗得厉害，可以使用top的-H选项查看线程的情况，使用-p选择指定pid

```sh
top -H -p 18400
```
可以使用jstack看看线程的调用栈

```sh
jstack -F 18400 > tmp1.log
grep -A 50 18435 tmp1.log
```

